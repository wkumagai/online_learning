# 売買戦略全般の説明書

## 1. 戦略の基本概念

投資戦略とは、市場データを分析し、いつ・何を・どれだけ売買するかを決定するための体系的なアプローチです。優れた戦略は以下の要素を備えています：

- **客観性**: 感情に左右されない明確なルールに基づいている
- **一貫性**: 市場環境に関わらず同じ方法で実行できる
- **検証可能性**: 過去のデータで検証できる
- **適応性**: 市場環境の変化に対応できる

### リスク管理の重要性

戦略を実装する際は、以下のリスク管理原則を考慮することが不可欠です：

- **ポジションサイズ**: 1回のトレードで資金の1-2%以上をリスクにさらさない
- **分散投資**: 複数の銘柄や資産クラスに分散する
- **相関関係**: 選択した銘柄間の相関関係を考慮する
- **最大ドローダウン**: 許容できる最大損失額を事前に決定する
- **リスク/リワード比**: 最低でも1:2以上のリスク/リワード比を目指す

### 戦略実装時の注意点

- **過剰最適化**: 過去のデータに過度に適合させると将来のパフォーマンスが低下する
- **取引コスト**: 手数料やスプレッドを考慮しないと実際の収益性が大きく変わる
- **流動性リスク**: 流動性の低い銘柄では大きなスリッページが発生する可能性がある
- **システムリスク**: 技術的な障害や接続問題に備えたバックアッププランが必要
- **心理的要因**: 戦略を機械的に実行する規律が必要

## 2. 株価・ニュースからシグナル生成までの流れ

### 基本的なデータフロー

```
市場データ取得 → データ前処理 → 特徴量生成 → シグナル生成 → 取引実行
```

### 詳細なプロセス

1. **市場データ取得**
   - 株価データ（OHLCV）の取得
   - ニュースデータの取得
   - 企業の財務データの取得（必要に応じて）

2. **データ前処理**
   - 欠損値の処理
   - 異常値の検出と処理
   - データの正規化/標準化
   - 時系列データの整列

3. **特徴量生成**
   - テクニカル指標の計算（移動平均、RSI、MACDなど）
   - ニュースのセンチメント分析
   - ボラティリティ指標の計算
   - 相対的な指標（セクター平均との比較など）

4. **シグナル生成**
   - ルールベースの条件判定
   - 機械学習モデルによる予測
   - 複数指標の組み合わせ
   - シグナルのフィルタリング

5. **取引実行**
   - ポジションサイズの決定
   - 注文タイプの選択
   - 執行タイミングの最適化
   - リスク管理ルールの適用

## 3. モデルを用いた株価予測とシグナル生成

### 主な予測モデル

1. **統計モデル**
   - 自己回帰和分移動平均（ARIMA）
   - 一般化自己回帰条件付き分散不均一（GARCH）
   - 状態空間モデル

2. **機械学習モデル**
   - ランダムフォレスト
   - 勾配ブースティング（XGBoost, LightGBM）
   - サポートベクターマシン（SVM）

3. **ディープラーニングモデル**
   - 長短期記憶（LSTM）ネットワーク
   - 畳み込みニューラルネットワーク（CNN）
   - Transformer（注意機構）

### 予測からシグナルへの変換

1. **閾値ベース**
   - 予測値が特定の閾値を超えた場合にシグナル生成
   - 例: 上昇確率が70%以上なら買いシグナル

2. **確率ベース**
   - 予測の確信度に基づいてポジションサイズを調整
   - 例: 上昇確率が90%なら最大ポジション、70%なら半分のポジションサイズ

3. **相対ランキング**
   - 複数銘柄の予測値をランキングし、上位N銘柄を選択
   - 例: 予測リターンが最も高い10銘柄に均等配分

4. **アンサンブル手法**
   - 複数モデルの予測を組み合わせてロバスト性を向上
   - 例: 3つのモデルのうち2つ以上が買いシグナルを出した場合のみ実行

### 実装例: LSTMモデルによる予測とシグナル生成

```python
def generate_signals_from_predictions(predictions, threshold=0.55):
    """
    予測値からトレーディングシグナルを生成
    
    Parameters:
    -----------
    predictions : numpy.ndarray
        上昇確率の予測値（0-1の範囲）
    threshold : float
        シグナル生成の閾値
        
    Returns:
    --------
    pandas.Series
        トレーディングシグナル（1: 買い, 0: 中立, -1: 売り）
    """
    signals = np.zeros(len(predictions))
    signals[predictions > threshold] = 1  # 買いシグナル
    signals[predictions < (1 - threshold)] = -1  # 売りシグナル
    return pd.Series(signals)
```

## 4. safe-ruleの取り扱い

safe-ruleとは、極端な市場状況や異常な価格変動から資産を守るための緊急対応ルールです。通常の戦略ロジックよりも優先して適用されます。

### 主なsafe-rule

1. **暴落対応ルール**
   - 短期間で一定以上の下落が発生した場合、全ポジションを清算
   - 例: 1日で5%以上、または3日連続で合計8%以上の下落

2. **急騰対応ルール**
   - 短期間で異常な上昇が発生した場合、利益確定または新規買い控え
   - 例: 1日で10%以上の上昇後は新規買いを行わない

3. **ボラティリティ制限**
   - 市場のボラティリティが異常に高い場合、ポジションサイズを縮小
   - 例: VIX指数が30を超えた場合、通常の半分のポジションサイズに制限

4. **ニュースフィルター**
   - 重要な経済指標発表や企業イベント前後は取引を控える
   - 例: 決算発表の前後2日間は当該銘柄の新規取引を行わない

5. **流動性チェック**
   - 取引量が通常より著しく少ない場合、取引を控える
   - 例: 過去20日平均の50%未満の出来高の場合は取引しない

### safe-ruleの実装例

```python
def apply_safe_rules(signals, price_data, volatility_index, news_events):
    """
    safe-ruleを適用してシグナルを調整
    
    Parameters:
    -----------
    signals : pandas.Series
        元のトレーディングシグナル
    price_data : pandas.DataFrame
        価格データ
    volatility_index : pandas.Series
        ボラティリティ指標（VIXなど）
    news_events : list
        重要イベントの日付リスト
        
    Returns:
    --------
    pandas.Series
        調整後のトレーディングシグナル
    """
    adjusted_signals = signals.copy()
    
    # 暴落チェック（1日で5%以上の下落）
    daily_returns = price_data['Close'].pct_change()
    crash_days = daily_returns < -0.05
    adjusted_signals[crash_days] = -1  # 売りシグナルに変更
    
    # 急騰チェック（1日で10%以上の上昇）
    spike_days = daily_returns > 0.10
    adjusted_signals[spike_days] = 0  # 中立シグナルに変更
    
    # ボラティリティチェック
    high_vol_days = volatility_index > 30
    adjusted_signals[high_vol_days] = adjusted_signals[high_vol_days] * 0.5  # シグナル強度を半減
    
    # ニュースイベントチェック
    for event_date in news_events:
        # イベント前後2日間は取引を控える
        event_window = pd.date_range(
            start=event_date - pd.Timedelta(days=2),
            end=event_date + pd.Timedelta(days=2)
        )
        adjusted_signals[adjusted_signals.index.isin(event_window)] = 0
    
    return adjusted_signals
```

### 他戦略との優先関係

safe-ruleは通常、以下の優先順位で適用されます：

1. **システム安全性ルール**: API障害検出、データ異常検出など
2. **市場安全性ルール**: 暴落対応、ボラティリティ制限など
3. **リスク管理ルール**: 最大ポジションサイズ、最大損失制限など
4. **通常の戦略ロジック**: テクニカル分析、機械学習予測など

この優先順位により、異常な市場状況下でも資産を保護しながら、通常時は戦略に従った取引を行うことができます。